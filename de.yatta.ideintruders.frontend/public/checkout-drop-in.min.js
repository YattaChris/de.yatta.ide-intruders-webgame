const e=e=>"http://localhost:"+e;var t;const s={chckoutUrl:(t=e(8013),t+"/chckout"),staticPagesUrl:e(4400),webshopUrl:e(4200),webshopDemoUrl:e(6200)};class i{constructor(e,t){this.urlHandler=e,this.pageLoadTypeDetector=t}initFrame(e,t){const s=this.urlHandler.parseQuery(e);t({action:"init",hostRelativeRef:this.urlHandler.getResetRelativeReference(e),autostartRef:s,isReload:this.pageLoadTypeDetector.isReload()})}}class n{constructor(e){this.window=e,this.bodyStyles=this.window.document.body.style,this.styleDump=null,this.appsHiding=[]}hideBodyScrollbars(e){0===this.appsHiding.length&&null===this.styleDump&&(this.saveStyleDump(),this.hideScrollbars()),this.appsHiding.includes(e)||this.appsHiding.push(e)}saveStyleDump(){this.styleDump={bodyOverflowX:this.bodyStyles.overflowX,bodyOverflowY:this.bodyStyles.overflowY,bodyPaddingBottom:this.bodyStyles.paddingBottom,bodyPaddingRight:this.bodyStyles.paddingRight,bodyMinWidth:this.bodyStyles.minWidth,bodyWidth:this.bodyStyles.width}}hideScrollbars(){const e=this.window.getComputedStyle(this.window.document.body),t=this.computePaddingBottom(e),s=this.computePaddingRight(e),i=this.computeMinimumBodyWidth(e);this.bodyStyles.overflowX="hidden",this.bodyStyles.overflowY="hidden",this.bodyStyles.paddingBottom=t+"px",this.bodyStyles.paddingRight=s+"px",this.bodyStyles.minWidth=i+"px",this.bodyStyles.width="initial"}computePaddingBottom(e){const t=this.window.document.documentElement,s=this.window.innerHeight-t.clientHeight;return parseFloat(e.paddingBottom)+s}computeMinimumBodyWidth(e){const t=this.window.document.body;return t.scrollWidth<=t.clientWidth||/Android|webOS|iPhone|iPad|Mac|Macintosh|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?0:"border-box"===e.boxSizing?t.scrollWidth+this.computePaddingRight(e):t.scrollWidth}computePaddingRight(e){const t=this.window.document.documentElement,s=this.window.innerWidth-t.clientWidth;return parseFloat(e.paddingRight)+s}resetBodyScrollbars(e){const t=this.appsHiding.indexOf(e);t>-1&&(1===this.appsHiding.length&&null!==this.styleDump&&(this.applyStyleDump(this.styleDump),this.styleDump=null),this.appsHiding.splice(t,1))}applyStyleDump(e){this.bodyStyles.overflowX=e.bodyOverflowX,this.bodyStyles.overflowY=e.bodyOverflowY,this.window.document.documentElement.scrollLeft,this.bodyStyles.paddingBottom=e.bodyPaddingBottom,this.bodyStyles.paddingRight=e.bodyPaddingRight,this.bodyStyles.minWidth=e.bodyMinWidth,this.bodyStyles.width=e.bodyWidth}}class o{constructor(e){this.window=e,this.iframes={},this.scrollbarManager=new n(this.window)}createFrame(e,t,s,i){var n,o,a;this.iframes[e]={iframe:this.window.document.createElement("iframe"),initialStyles:s};const r=this.getIFrameOrThrow(e);r.src=t,r.name=e,r.style.position="fixed",r.style.left="0",r.style.top="0",r.style.width=s.width,r.style.height="100%",r.style.padding="0",r.style.border="none",r.style.margin="0",r.style.zIndex=s.zIndex,r.style.display=s.display,r.style.filter=null!==(n=s.filter)&&void 0!==n?n:"",r.style.transition=null!==(o=s.transition)&&void 0!==o?o:"",r.scrolling=null!==(a=s.scrolling)&&void 0!==a?a:"yes",this.window.document.body.appendChild(r),i&&r.addEventListener("load",()=>i())}showFrame(e){const t=this.getIFrameOrThrow(e);t.style.display="block",t.focus(),this.scrollbarManager.hideBodyScrollbars(e)}hideFrame(e){this.getIFrameOrThrow(e).style.display="none",this.scrollbarManager.resetBodyScrollbars(e)}sendMessageToFrame(e,t){const s=this.getIFrameOrThrow(e);s.contentWindow?s.contentWindow.postMessage(t,s.src):s.addEventListener("load",()=>this.sendMessageToFrame(e,t))}onReceiveMessageFromFrame(e,t,s){this.window.addEventListener("message",i=>{i.origin===this.getHostname(e)&&i.data.source===t&&s(i.data)})}setFrameWidth(e,t){var s;const i=this.getIFrameWithSettingsOrThrow(e),n=this.isSettingToFullWidth(t);n||i.iframe.style.width.startsWith("0")?i.iframe.style.transition="":n||(i.iframe.style.transition=null!==(s=i.initialStyles.transition)&&void 0!==s?s:""),i.iframe.style.width=t,n&&"none"!==i.iframe.style.display?this.scrollbarManager.hideBodyScrollbars(e):this.scrollbarManager.resetBodyScrollbars(e)}isSettingToFullWidth(e){return e.endsWith("px")?Number(e.split("px",1)[0])>=this.window.innerWidth:!!e.endsWith("%")&&Number(e.split("%",1)[0])>=100}getHostname(e){const t=this.window.document.createElement("a");return t.href=this.getIFrameOrThrow(e).src,`${t.protocol}//${t.host}`}getIFrameWithSettingsOrThrow(e){if(void 0!==this.iframes[e])return this.iframes[e];throw new Error("IFrame "+e+" not initialized")}getIFrameOrThrow(e){return this.getIFrameWithSettingsOrThrow(e).iframe}}class a{constructor(e){this.window=e}isReload(){var e;const t=null===(e=this.window.performance.getEntriesByType("navigation").find(e=>void 0!==e))||void 0===e?void 0:e.type;return"reload"===t||"back_forward"===t}}class r{constructor(e){this.window=e}parseQuery(e){return this.getQueryParameter(e)}getQueryParameter(e){const{search:t}=this.window.location,s=new RegExp(`[?&]${e}=([^&#]*)`).exec(t);return null!==s?decodeURIComponent(s[1]):null}resetRelativeReference(e){const{document:{title:t}}=this.window;this.window.history.replaceState({},t,this.getResetRelativeReference(e))}getResetRelativeReference(e){const{location:{pathname:t,search:s,hash:i}}=this.window;return t+this.deleteQueryParameter(s,e).replace(new RegExp("^&"),"?")+i}deleteQueryParameter(e,t){const s=new RegExp(`[?&]${t}=([^&#]*)`,"g");return e.replace(s,"")}}class l{constructor(e){this.window=e,this.onSignedInChangeCallbacks={callbacks:[]},this.onAssetStatusChangeCallbacks={},this.onLicenseSessionChangeCallbacks={callbacks:[]}}publishInterface(e){const t="checkout-drop-in";this.window.yatta={startCheckout:(s,i)=>e({source:t,action:"startCheckout",productId:this.sanitizeProductId(s),params:this.sanitizeCheckoutParams(i)}),onSignedInChange:e=>this.registerSignedInChangeCallback(this.sanitizeCallback(e)),onAssetStatusChange:(t,s,i)=>this.registerAssetStatusChangeCallback(e,this.sanitizeProductId(t),this.sanitizeCallback(s),this.sanitizeEnvironment(i)),onLicenseSessionChange:(t,s)=>this.registerLicenseSessionChangeCallback(e,this.sanitizeProductId(t),this.sanitizeCallback(s)),signIn:s=>e({source:t,action:"signIn",params:this.sanitizeAuthenticationParams(s)}),signOut:()=>e({source:t,action:"signOut"}),linkAccount:s=>e({source:t,action:"linkAccount",accountId:this.sanitizeAccountId(s)}),startAcademicRegistration:s=>e({source:t,action:"startAcademicRegistration",params:this.sanitizeAcademicParams(s)})}}sanitizeCheckoutParams(e){return{manageAssetHint:this.sanitizeManageAssetHint(null==e?void 0:e.manageAssetHint),environment:this.sanitizeEnvironment(null==e?void 0:e.environment),start:this.sanitizeCheckoutStart(null==e?void 0:e.start),authenticationParams:this.sanitizeAuthenticationParams(null==e?void 0:e.authenticationParams)}}sanitizeCheckoutStart(e){var t;if(void 0!==(null==e?void 0:e.type)&&null!==(null==e?void 0:e.type)&&"oneTimePurchase"!==(null==e?void 0:e.type)&&"subscription"!==(null==e?void 0:e.type))throw new Error(`Type ${JSON.stringify(null==e?void 0:e.type)} not supported.`);if("subscription"===(null==e?void 0:e.type)){if(void 0!==(null==e?void 0:e.subscriptionInterval)&&null!==(null==e?void 0:e.subscriptionInterval)&&"monthly"!==(null==e?void 0:e.subscriptionInterval)&&"quarterly"!==(null==e?void 0:e.subscriptionInterval)&&"yearly"!==(null==e?void 0:e.subscriptionInterval))throw new Error(`SubscriptionInterval ${JSON.stringify(null==e?void 0:e.subscriptionInterval)} not supported.`);return{type:null==e?void 0:e.type,subscriptionInterval:null!==(t=null==e?void 0:e.subscriptionInterval)&&void 0!==t?t:"monthly"}}return{type:"oneTimePurchase"}}sanitizeManageAssetHint(e){if(null!=e&&!0!==e&&!1!==e)throw new Error(`ManageAssetHint ${JSON.stringify(e)} not supported.`);return null!=e&&e}sanitizeEnvironment(e){if(null!=e&&"live"!==e&&"preview"!==e)throw new Error(`Environment ${JSON.stringify(e)} not supported.`);return null!=e?e:"live"}sanitizeAuthenticationParams(e){var t;return{emailHint:null!==(t=null==e?void 0:e.emailHint)&&void 0!==t?t:null}}sanitizeAccountId(e){if(void 0===e)throw new Error("AccountId not defined.");return e}sanitizeAcademicParams(e){var t,s,i,n,o,a,r,l;if(void 0!==(null===(t=null==e?void 0:e.start)||void 0===t?void 0:t.type)&&null!==(null===(s=null==e?void 0:e.start)||void 0===s?void 0:s.type)&&"student"!==(null===(i=null==e?void 0:e.start)||void 0===i?void 0:i.type)&&"teacher"!==(null===(n=null==e?void 0:e.start)||void 0===n?void 0:n.type)&&"organization"!==(null===(o=null==e?void 0:e.start)||void 0===o?void 0:o.type))throw new Error(`Type ${JSON.stringify(null===(a=null==e?void 0:e.start)||void 0===a?void 0:a.type)} not supported.`);return{productId:this.sanitizeProductId(null==e?void 0:e.productId,"Academic registration without productId not yet supported."),start:{type:null!==(l=null===(r=null==e?void 0:e.start)||void 0===r?void 0:r.type)&&void 0!==l?l:"student"}}}sanitizeProductId(e,t="ProductId is missing."){if(null==e)throw new Error(t);return e}sanitizeCallback(e){if("function"!=typeof e)throw new Error("Callback must be provided as a function.");return e}registerSignedInChangeCallback(e){const t=this.onSignedInChangeCallbacks.lastValue;void 0!==t&&e(t),this.onSignedInChangeCallbacks.callbacks.push(e)}registerAssetStatusChangeCallback(e,t,s,i){if(void 0!==this.onAssetStatusChangeCallbacks[t]&&void 0!==this.onAssetStatusChangeCallbacks[t][i]){const e=this.onAssetStatusChangeCallbacks[t][i].lastValue;void 0!==e&&s(e),this.onAssetStatusChangeCallbacks[t][i].callbacks.push(s)}else{const e={lastValue:null,callbacks:[s]};void 0!==this.onAssetStatusChangeCallbacks[t]?this.onAssetStatusChangeCallbacks[t][i]=e:this.onAssetStatusChangeCallbacks[t]={[i]:e}}e({source:"checkout-drop-in",action:"registerForAssetStatusChange",productId:t,environment:i})}registerLicenseSessionChangeCallback(e,t,s){const i=this.onLicenseSessionChangeCallbacks.lastValue;void 0!==i&&s(i),this.onLicenseSessionChangeCallbacks.callbacks.push(s),e({source:"checkout-drop-in",action:"registerForLicenseSessionChange",productId:t})}notifySignedInChange(e){this.onSignedInChangeCallbacks.lastValue=e;for(const t of this.onSignedInChangeCallbacks.callbacks)t(e)}notifyAssetStatusChange(e,t,s){if(void 0!==this.onAssetStatusChangeCallbacks[e]&&void 0!==this.onAssetStatusChangeCallbacks[e][t]){this.onAssetStatusChangeCallbacks[e][t].lastValue=s;for(const i of this.onAssetStatusChangeCallbacks[e][t].callbacks)i(s)}}notifyLicenseSessionChange(e){this.onLicenseSessionChangeCallbacks.lastValue=e;for(const t of this.onLicenseSessionChangeCallbacks.callbacks)t(e)}}class h{constructor(e){this.window=e}isSupported(){return this.supportsCssVariables()&&this.supportsGlobalThis()}supportsCssVariables(){return!(!this.window.CSS||!this.window.CSS.supports("color","var(--test-var)"))}supportsGlobalThis(){return"object"==typeof globalThis}showNotSupportedWindow(e){const t=this.window.top,s=t?t.outerHeight/2+t.screenY-201:0,i=t?t.outerWidth/2+t.screenX-219:0,n=`${e}/web-checkout/browser-not-supported/${this.isIE()?"ie":"other"}`;return this.window.open(n,"",`toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width=438, height=402, top=${s}, left=${i}`),!1}isIE(){return/msie\s|trident\//i.test(this.window.navigator.userAgent)}}new class{constructor(e,t){this.window=e,this.document=t,this.earlyMessagesQueueProcessed=!1,this.earlyMessagesQueue=[],this.checkoutFramesCreated=!1,this.CHECKOUT_FRAME_NAME="yatta-checkout",this.CHECKOUT_DEMO_FRAME_NAME="yatta-checkout-demo",this.CHECKOUT_DEMO_EXCLUDED_KEY="checkoutDemoExcluded",this.CHECKOUT_INITIAL_STYLES={zIndex:"2147483647",display:"none",width:"100%"}}execute(){this.apiService=new l(this.window),this.browserSupportService=new h(this.window),this.iFrameManager=new o(this.window),this.pageLoadTypeDetector=new a(this.window),this.urlHandler=new r(this.window),this.iFrameInitService=new i(this.urlHandler,this.pageLoadTypeDetector),this.apiService.publishInterface(e=>this.decideOnFrameAndHandleMessageToCheckoutFrame(e)),this.browserSupportService.isSupported()?this.addInitEventListeners():this.addInitEventListenersIfBrowserNotSupported()}addInitEventListeners(){this.document.addEventListener("readystatechange",()=>this.createCheckoutFrames()),this.createCheckoutFrames()}createCheckoutFrames(){if("loading"!==this.document.readyState){if(this.checkoutFramesCreated)return;this.checkoutFramesCreated=!0,this.createCheckoutFrame(),"localhost"===this.window.location.hostname&&this.createCheckoutDemoFrame()}}createCheckoutFrame(){const e=s.webshopUrl;this.iFrameManager.createFrame(this.CHECKOUT_FRAME_NAME,e,this.CHECKOUT_INITIAL_STYLES,()=>this.initCheckoutFrame()),this.iFrameManager.onReceiveMessageFromFrame(this.CHECKOUT_FRAME_NAME,"web-checkout",e=>this.handleMessageFromCheckoutFrame(e))}initCheckoutFrame(){this.processEarlyMessagesQueueBeforeFrameInit(),this.iFrameInitService.initFrame("startYattaCheckout",e=>this.handleMessageToCheckoutFrame(this.CHECKOUT_FRAME_NAME,Object.assign(Object.assign({},e),{source:"checkout-drop-in"})))}processEarlyMessagesQueueBeforeFrameInit(){this.earlyMessagesQueueProcessed=!0,this.earlyMessagesQueue.forEach(e=>this.decideOnFrameAndHandleMessageToCheckoutFrame(e)),this.earlyMessagesQueue=[]}createCheckoutDemoFrame(){const e=s.webshopDemoUrl;this.iFrameManager.createFrame(this.CHECKOUT_DEMO_FRAME_NAME,e,this.CHECKOUT_INITIAL_STYLES),this.iFrameManager.onReceiveMessageFromFrame(this.CHECKOUT_DEMO_FRAME_NAME,"web-checkout-demo",e=>this.handleCloseFrameMessage(e,this.CHECKOUT_DEMO_FRAME_NAME))}handleMessageFromCheckoutFrame(e){switch(e.action){case"notifyAssetStatusChange":this.apiService.notifyAssetStatusChange(e.productId,e.environment,e.assetStatus);break;case"notifySignedInChange":this.apiService.notifySignedInChange(e.signedIn);break;case"notifyLicenseSessionChange":this.apiService.notifyLicenseSessionChange(e.licenseSession);break;case"closeFrame":this.handleCloseFrameMessage(e,this.CHECKOUT_FRAME_NAME);break;case"confirmAutostart":this.urlHandler.resetRelativeReference("startYattaCheckout")}}handleCloseFrameMessage(e,t){"closeFrame"===e.action&&this.iFrameManager.hideFrame(t)}decideOnFrameAndHandleMessageToCheckoutFrame(e){var t;if(this.earlyMessagesQueueProcessed){if("startCheckout"===e.action&&!0!==(null===(t=e.params)||void 0===t?void 0:t.manageAssetHint)){const t="localhost"===this.window.location.hostname;let i,n=!0;try{i=this.window.localStorage.getItem(this.CHECKOUT_DEMO_EXCLUDED_KEY)}catch(e){n=!1,i=null}const o=i?JSON.parse(i):[];if(t&&!o.includes(e.productId))return void fetch(s.chckoutUrl+"/webshop-demo/check-license-id-type?licenseId="+e.productId).then(e=>{if(!e.ok){throw new Error("HTTP status code: "+e.status)}return e.json()}).then(t=>{!1===t.demoMode&&n&&this.window.localStorage.setItem(this.CHECKOUT_DEMO_EXCLUDED_KEY,JSON.stringify(o.concat([e.productId]))),this.handleMessageToCheckoutFrame(t.demoMode?this.CHECKOUT_DEMO_FRAME_NAME:this.CHECKOUT_FRAME_NAME,e)}).catch(()=>this.handleMessageToCheckoutFrame(this.CHECKOUT_FRAME_NAME,{source:"checkout-drop-in",action:"showError",errorType:"SOLUTION_ID_DEMO_CHECK_FAILED"}))}this.handleMessageToCheckoutFrame(this.CHECKOUT_FRAME_NAME,e)}else this.earlyMessagesQueue.push(e)}handleMessageToCheckoutFrame(e,t){this.handleMessageToFrame(e,t),"signOut"===t.action||"registerForAssetStatusChange"===t.action||"registerForLicenseSessionChange"===t.action||"linkAccount"===t.action||"init"===t.action&&null===t.autostartRef&&!t.isReload||this.iFrameManager.showFrame(e)}handleMessageToFrame(e,t){this.browserSupportService.isSupported()?this.iFrameManager.sendMessageToFrame(e,t):this.browserSupportService.showNotSupportedWindow(s.staticPagesUrl)}addInitEventListenersIfBrowserNotSupported(){this.window.addEventListener("load",()=>{let e=!1;this.urlHandler.parseQuery("startYattaCheckout")&&(e=!0,this.urlHandler.resetRelativeReference("startYattaCheckout")),e&&this.browserSupportService.showNotSupportedWindow(s.staticPagesUrl)})}}(window,document).execute();
